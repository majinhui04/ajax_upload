<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>ajax upload</title>
</head>
<body>
	<form action="upload.php" name="f1" id="f1">
		<p>
			file:
			<input type="file" name="file" id="file" multiple>
			<input type="button" name="ajax" id="ajaxbtn" value="ajaxbtn">
			<input type="submit" name="submit" value="submit">
		</p>	
		<p>
			load:<b id="result">0</b>%
		</p>

	</form>

	<script type="text/javascript">
		function S4() {
		   return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
		};

		function guid() {
		   return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
		};
		var $ = function(id){

			return document.getElementById(id);
		};

		//var fileSliceSize = 1024*100; //100K
		var fileSliceSize = 1024*1024*5; //5M
		function fileUpload(file){
			var name = file.name;
			var size = file.size;
			var start = 0;
			var count = 0;

			if( localStorage.getItem(name) ){
				start = parseInt( localStorage.getItem(name) );
				if(start >= size){
					alert('已经上传完毕');
					return;
				}
			}

			var upload = function(){
				var data = new FormData();
				console.log('------------------------------',count);
				console.log('start:',start,' end:',start+fileSliceSize);
				data.append("start", start );
				data.append("fileSliceSize", fileSliceSize );
				data.append("size", size );
				data.append("fileid", guid() );
				data.append("name", encodeURIComponent(name));
				data.append("file", file.slice(start, start+fileSliceSize) );

				var xhr = new XMLHttpRequest();
				// 上传进度中
				xhr.upload.addEventListener("progress", function(e) {
					//console.log(e)
					//objStateElement.backgroundSize(fileid, (e.loaded + start) / size * 100);
				}, false);
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4){
						if(xhr.status == 200 && xhr.responseText){
							var result = xhr.responseText;
							console.log(result)
							try{
								var json = JSON.parse(xhr.responseText);

								var next = parseInt(json.start);
								console.log('next ',next,size,next/size,parseInt(next/size));
								start = start+fileSliceSize;
								//本地存储
								localStorage.setItem(name,start);

								var percent = parseInt(next/size*100);
								$('result').innerHTML = percent;
								console.log(json);
								count ++;
								if( (start)>=size ){
									percent = 100;
									$('result').innerHTML = percent;
									console.log('complete');
									return;
								}
								setTimeout(function(){
									upload();
								}, 10)
								
								
								
							}catch(error){
								console.warn(error)
							}
						}

					}

				};
				xhr.open("post", 'upload.php', false);
				xhr.setRequestHeader('X-Request-With','XMLHttpRequest');
				xhr.send(data);


			};

			upload();


		}
		$('file').addEventListener('change', function(){
			var files = this.files,file = files[0];
			console.log('files ',files);
			console.log(file.name+' start ',localStorage.getItem(file.name) )

		}, false);


		$('ajaxbtn').addEventListener('click', function(){
			var $file = $('file'),files = $file.files,file = files[0];

			if(!file){
				return;

			}
			/*for (var i = files.length - 1; i >= 0; i--) {
				file = files[i];
				console.log(111111)
				console.log('name ',file.name,' size ',file.size);
				fileUpload(file);
			};*/
			console.log(111111)
			console.log('name ',file.name,' size ',file.size);
			fileUpload(file);
			
			

				

		}, false);



	</script>
</body>
</html>